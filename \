from app.utils.parser import parse
from app.services.celery.celery_main import celery
from app.services.s3 import S3Client
from typing import List, Tuple, Literal
import json
import asyncio


async def parse_valid(
    url: str,
    main: tuple[str, str],
    elements: List[Tuple[str, str, Literal["text", "src"], str]],
    bucket_name: str,
):
    something_dict = await parse(
        url=url,
        main=main,
        elements=elements,
    )
    # NOTE: I know that's not correct but just for viewers and None's theme read about it

    if not isinstance(something_dict, type(None)):
        async with httpx.AsyncClient() as client:
            resp = await client.get(image_url)
            resp.raise_for_status()
            content = resp.content  # bytes
        for i in something_dict.values():
            await S3Client(bucket_name=bucket_name).upload_file(
                file=i.get("image"),
                name_file="CategoriesPohoto/" + i.get("name").lower(),
            )


def get_somet_task(
    url: str,
    main: tuple[str, str],
    elements: List[Tuple[str, str, Literal["text", "src"], str]],
    bucket_name: str,
):
    asyncio.run(
        parse_valid(
            url=url,
            main=main,
            elements=elements,
            bucket_name=bucket_name,
        )
    )


download_categories = celery.task(name="download_categories")(get_somet_task)
