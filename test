import { CameraView, CameraType, useCameraPermissions } from 'expo-camera';
import * as MediaLibrary from 'expo-media-library';
import { useState, useEffect } from 'react';
import { Pressable, StyleSheet, Text, View, ScrollView, Image, ActivityIndicator } from 'react-native';

export default function App() {
	const [facing, setFacing] = useState<CameraType>('back');
	const [albums, setAlbums] = useState<MediaLibrary.Album[]>();
	const [loading, setLoading] = useState(false);
	const [cameraPermission, requestCameraPermission] = useCameraPermissions();
	const [mediaPermission, requestMediaPermission] = MediaLibrary.usePermissions();

	async function getAlbums() {
		try {
			setLoading(true);

			if (mediaPermission && mediaPermission.status !== 'granted') {
				const permission = await requestMediaPermission();
				if (permission.status !== 'granted') {
					alert('–î–æ—Å—Ç—É–ø –∫ –≥–∞–ª–µ—Ä–µ–µ –∑–∞–ø—Ä–µ—â–µ–Ω');
					return;
				}
			}

			const fetchedAlbums = await MediaLibrary.getAlbumsAsync({
				includeSmartAlbums: true,
			});
			setAlbums(fetchedAlbums);
		} catch (error) {
			console.error('Error fetching albums:', error);
		} finally {
			setLoading(false);
		}
	}

	if (!mediaPermission) {
		return (
			<View>
				<ActivityIndicator size="large" color="#3b82f6" />
				<Text>–ó–∞–≥—Ä—É–∑–∫–∞...</Text>
			</View>
		);
	}

	if (!mediaPermission.granted) {
		return (
			<View>
				<Text >üì∑</Text>
				<Text >–ù—É–∂–Ω—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</Text>
				<Text >
					–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ñ–æ—Ç–æ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –≥–∞–ª–µ—Ä–µ–µ
				</Text>
				<Pressable
					onPress={requestMediaPermission}
				>
					<Text >–†–∞–∑—Ä–µ—à–∏—Ç—å –≥–∞–ª–µ—Ä–µ—é</Text>
				</Pressable>
			</View>
		);
	}

	return (
		<View>
			<Pressable
				onPress={getAlbums}
				disabled={loading}
			>
				<Text>
					{loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : 'üì∑ –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª—å–±–æ–º—ã'}
				</Text>
			</Pressable>

			{loading && <ActivityIndicator size="large" color="#3b82f6" />}

			<ScrollView>
				{albums?.map((album) => (
					<AlbumEntry key={album.id} album={album} />
				))}
			</ScrollView>
		</View>
	);
}

function AlbumEntry({ album }: { album: MediaLibrary.Album }) {
	const [assets, setAssets] = useState<MediaLibrary.Asset[]>([]);
	const [loading, setLoading] = useState(true);

	useEffect(() => {
		async function getAlbumAssets() {
			try {
				const albumAssets = await MediaLibrary.getAssetsAsync({
					album,
					first: 1, // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
				});
				setAssets(albumAssets.assets);
			} catch (error) {
				console.error('Error fetching assets:', error);
			} finally {
				setLoading(false);
			}
		}
		getAlbumAssets();
	}, [album.id]);

	return (
		<View>
			<View>
				<Image
					source={{ uri: assets[0]?.uri }}
				/>
				<Text>{album.title}</Text>
				<Text>({album.assetCount || 0})</Text>
			</View>
		</View>
	);
}

